name: Build Windows + Mac Installers

on: workflow_dispatch

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build Windows EXE
        run: |
          pyinstaller main_desktop.spec
      
      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: MandarinTTS-Windows
          path: dist/MandarinTTS/

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Mac system dependencies
        run: |
          brew install python-tk
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build Mac App
        run: |
          pyinstaller main_desktop.spec
          
      - name: Debug - Check build structure
        run: |
          echo "=== Checking dist directory ==="
          ls -la dist/
          echo ""
          echo "=== Checking for .app bundle ==="
          find dist/ -name "*.app" -type d
          echo ""
          if [ -d "dist/MandarinTTS.app" ]; then
            echo "=== Contents of MandarinTTS.app ==="
            ls -la dist/MandarinTTS.app/
            ls -la dist/MandarinTTS.app/Contents/
            ls -la dist/MandarinTTS.app/Contents/MacOS/
          fi
          
      - name: Fix permissions and validate
        run: |
          # ËÆæÁΩÆÂèØÊâßË°åÊùÉÈôê
          chmod +x dist/MandarinTTS.app/Contents/MacOS/MandarinTTS
          
          echo "=== File type ==="
          file dist/MandarinTTS.app/Contents/MacOS/MandarinTTS
          
          echo "=== Architecture ==="
          lipo -info dist/MandarinTTS.app/Contents/MacOS/MandarinTTS
          
          echo "=== Dynamic libraries ==="
          otool -L dist/MandarinTTS.app/Contents/MacOS/MandarinTTS | head -20
          
          echo "=== Code signature status ==="
          codesign -dv dist/MandarinTTS.app 2>&1 || echo "Not signed (expected for unsigned builds)"
          
          echo "=== Validation complete - skipping GUI launch test ==="
          echo "GUI applications cannot be tested in headless CI environment"
          
      - name: Create distribution package
        run: |
          # ‰ΩøÁî® ZIP Ê†ºÂºèÔºàÊõ¥ÂèØÈù†ÔºåGitHub Actions ÂèãÂ•ΩÔºâ
          cd dist
          zip -r ../MandarinTTS-Mac.zip MandarinTTS.app
          cd ..
          
          echo "=== Package info ==="
          ls -lh MandarinTTS-Mac.zip
          
      - name: Verify package
        run: |
          echo "=== ZIP contents ==="
          unzip -l MandarinTTS-Mac.zip | head -20
          
      - name: Create installation instructions
        run: |
          cat > MACOS_INSTALL.txt << 'EOF'
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë      MandarinTTS macOS Installation Instructions           ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

          üì¶ Installation Steps:
          
          1. Download MandarinTTS-Mac.zip
          2. Double-click to extract (or right-click -> Open With -> Archive Utility)
          3. Drag MandarinTTS.app to the Applications folder
          4. Open Applications folder and locate MandarinTTS
          
          ‚ö†Ô∏è  First Launch (IMPORTANT):
          
          Method 1 (Recommended):
            ‚Ä¢ Right-click on MandarinTTS.app
            ‚Ä¢ Select "Open"
            ‚Ä¢ Click "Open" to confirm
          
          Method 2 (If still blocked):
            ‚Ä¢ Open Terminal
            ‚Ä¢ Run the following command:
              
              xattr -cr /Applications/MandarinTTS.app
              
            ‚Ä¢ Then right-click the app -> Open
          
          üîß Common Issues:
          
          Q: "App is damaged and can't be opened"
          A: Run: xattr -cr /Applications/MandarinTTS.app
          
          Q: "Cannot verify developer"
          A: Right-click and select "Open", do not double-click
          
          Q: App crashes or doesn't respond
          A: Ensure you have macOS 10.13 or later
          
          üìù System Requirements:
            ‚Ä¢ macOS 10.13 (High Sierra) or later
            ‚Ä¢ 100MB available disk space
            ‚Ä¢ Apple Silicon (M1/M2/M3) native support
            ‚Ä¢ Intel Mac supported via Rosetta 2
          
          üí° Note: This is an unsigned app. macOS Gatekeeper will perform 
              security checks. Following the steps above is safe.
          
          EOF
          
          echo "Created MACOS_INSTALL.txt"
      
      - name: Upload Mac ZIP
        uses: actions/upload-artifact@v4
        with:
          name: MandarinTTS-Mac
          path: MandarinTTS-Mac.zip
          
      - name: Upload Installation Instructions
        uses: actions/upload-artifact@v4
        with:
          name: MacOS-Installation-Guide
          path: MACOS_INSTALL.txt
          
      - name: Upload .app bundle (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: MandarinTTS-Mac-app-bundle
          path: dist/MandarinTTS.app/
